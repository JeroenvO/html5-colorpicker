colorPicker.prototype.draw=function(drawHandles){if(this.changed){this.ctx.save();this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);this.ctx.beginPath();this.ctx.rect(0,0,2*this.centerX,2*this.centerY);this.ctx.closePath();this.ctx.fillStyle=this.bgcolor;this.ctx.fill();this.ctx.translate(this.centerX,this.centerY);hsl=hsv2hsl(this.h/Math.PI*180,this.s*100,100);hsl='hsl('+hsl.h+','+hsl.s+'%,'+hsl.l+'%)';this.ctx.lineWidth=this.scale;this.ctx.beginPath();this.ctx.strokeStyle=hsl;this.ctx.arc(0,0,this.scale*4+this.scale/2,0,2*Math.PI,false);this.ctx.stroke();this.ctx.closePath();this.ctx.drawImage(this.clrImg,-this.scale*5,-this.scale*5,this.scale*10,this.scale*10);hsl=hsv2hsl(this.h/Math.PI*180,this.s*100,this.v*100);hsl='hsl('+hsl.h+','+hsl.s+'%,'+hsl.l+'%)';this.ctx.beginPath();this.ctx.arc(0,0,this.scale*1,0,2*Math.PI,false);this.ctx.closePath();this.ctx.fillStyle=hsl;this.ctx.fill();this.ctx.save();this.ctx.rotate(this.h);this.ctx.translate(this.scale+this.s*this.scale*3,0);this.drawHandle('c');this.ctx.restore();this.ctx.rotate(this.v*2*Math.PI);this.ctx.translate(this.scale*4.5,0);this.drawHandle('v');this.ctx.restore();}
this.changed=false;}
colorPicker.prototype.drawHandle=function(handle){var lw=Math.round(this.scale/6.66667,0);this.ctx.lineWidth=lw;this.ctx.beginPath();this.ctx.arc(0,0,this.scale/2-lw/2,0,2*Math.PI,false);this.ctx.closePath();this.ctx.fillStyle='rgba(0,0,0,0)';this.ctx.strokeStyle=(this.selected===handle)?'rgba(220,220,220,0.7)':'rgba(255,255,255,1)';this.ctx.stroke();this.ctx.fill();}
colorPicker.prototype.getMousePos=function(evt){var rect=this.canvas.getBoundingClientRect();return{x:evt.clientX-rect.left,y:evt.clientY-rect.top};}
colorPicker.prototype.getHandlers=function(){return{xv:this.centerX+Math.cos(this.v*2*Math.PI)*(this.scale*4.5),yv:this.centerY+Math.sin(this.v*2*Math.PI)*(this.scale*4.5),xc:this.centerX+Math.cos(this.h)*(this.scale*3*this.s+this.scale),yc:this.centerY+Math.sin(this.h)*(this.scale*3*this.s+this.scale)};}
colorPicker.prototype.contains=function(xMouse,yMouse){handlersPos=this.getHandlers();if((Math.pow(handlersPos.xv-xMouse,2)+Math.pow(handlersPos.yv-yMouse,2))<=this.scale/2*this.scale/2)
{return'v';}
if((Math.pow(handlersPos.xc-xMouse,2)+Math.pow(handlersPos.yc-yMouse,2))<=this.scale/2*this.scale/2)
{return'c';}
else
return false;}
function hsv2hsl(hue,sat,val){var l=(2-sat/100)*val/2;hsl={'h':hue,'s':sat*val/(l<50?l*2:200-l*2),'l':l};if(isNaN(hsl.s))hsl.s=0;return hsl;}
colorPicker.prototype.setWidth=function(w,h,centerX,centerY,scale){this.canvas.width=w;this.canvas.heigth=h;this.ctx.canvas.width=w;this.ctx.canvas.height=h;this.centerX=centerX||w/2;this.centerY=centerY||h/2;this.scale=scale||Math.min(w,h)/10;this.changed=true;}
colorPicker.prototype.getColorHSV=function(){return{h:this.h/(2*Math.PI),s:this.s,v:this.v}}
colorPicker.prototype.getColorHSL=function(){hsl=hsv2hsl(this.h,this.s,this.v)
return{h:hsl.h/(2*Math.PI),s:hsl.s,l:hsl.l}}
colorPicker.prototype.setColorHSV=function(h,s,v){this.h=h<=1?h*(2*Math.PI):0;this.s=(s<=1?s:0);this.v=(v<=1?v:0);this.changed=true;}
colorPicker.prototype.startDraw=function(){if(!this.drawID){var colorPicker=this;this.drawID=setInterval(function(){colorPicker.draw();},colorPicker.drawInterval);}}
colorPicker.prototype.stopDraw=function(){if(this.drawID){clearInterval(this.drawID);this.drawID=false;}}
function colorPicker(canvas,opts){this.canvas=canvas;this.ctx=canvas.getContext('2d');var colorPicker=this;this.clrImg=new Image();this.clrImg.src=opts.image||'color-500.png';this.h=0;this.s=0;this.v=0;this.changed=true;this.bgcolor=opts.bgcolor||'rgb(200,200,200)';this.setWidth(canvas.width,canvas.height,opts.centerX||false,opts.centerY||false,opts.scale||false);this.drawInterval=opts.drawInterval||10;this.onColorChange=opts.onColorChange||false;this.onCenterClick=opts.onCenterClick||false;this.setColorHSV(opts.h,opts.s,opts.v);if((typeof opts.autoStartDraw==='undefined')||opts.autoStartDraw==true){this.drawID=setInterval(function(){colorPicker.draw();},colorPicker.drawInterval);}else{this.drawID=false;}
canvas.addEventListener('mousedown',function(e){if(document.body.contains(colorPicker.canvas)){var mouse=colorPicker.getMousePos(e);colorPicker.selected=colorPicker.contains(mouse.x,mouse.y);if(!colorPicker.selected){var mx=mouse.x-colorPicker.centerX;var my=mouse.y-colorPicker.centerY;var len=Math.pow(mx,2)+Math.pow(my,2);if(len<=colorPicker.scale*colorPicker.scale*25){if(len>colorPicker.scale*colorPicker.scale){var angle=Math.atan2(my,mx);angle+=(my)<0?2*Math.PI:0;if(len<=colorPicker.scale*colorPicker.scale*16){colorPicker.h=angle;var s=(Math.sqrt(len)-colorPicker.scale)/3/colorPicker.scale;s=s>1?1:s;colorPicker.s=s<0?0:s;colorPicker.selected='c';if(colorPicker.onColorChange){colorPicker.onColorChange();}}
else{colorPicker.v=(angle/(2*Math.PI))%1;colorPicker.selected='v';if(colorPicker.onColorChange){colorPicker.onColorChange();}}}}}
colorPicker.changed=true;}});canvas.addEventListener('mousemove',function(e){if(colorPicker.selected&&document.body.contains(colorPicker.canvas)){if(colorPicker.onColorChange){colorPicker.onColorChange();}
var mouse=colorPicker.getMousePos(e);var mx=mouse.x-colorPicker.centerX;var my=mouse.y-colorPicker.centerY;var angle=Math.atan2(my,mx);angle+=my<0?2*Math.PI:0;if(colorPicker.selected=='c'){colorPicker.h=angle;var s=(Math.sqrt(Math.pow(mx,2)+Math.pow(my,2))-colorPicker.scale)/3/colorPicker.scale;s=s>1?1:s;s=s<0?0:s;colorPicker.s=s;}
else if(colorPicker.selected=='v'){colorPicker.v=(angle/(2*Math.PI))%1;}
colorPicker.changed=true;}});window.addEventListener('mouseup',function(e){if(colorPicker.selected&&document.body.contains(colorPicker.canvas)){colorPicker.selected=false;colorPicker.changed=true;}
if(colorPicker.onCenterClick&&document.body.contains(colorPicker.canvas)){var mouse=colorPicker.getMousePos(e);if((Math.pow(colorPicker.centerX-mouse.x,2)+Math.pow(colorPicker.centerY-mouse.y,2))<colorPicker.scale*colorPicker.scale){colorPicker.onCenterClick();}}});}